package com.securityc4po.api.pentest

import com.fasterxml.jackson.databind.ObjectMapper
import com.github.tomakehurst.wiremock.common.Json
import com.securityc4po.api.BaseDocumentationIntTest
import com.securityc4po.api.configuration.NP_NONNULL_FIELD_NOT_INITIALIZED_IN_CONSTRUCTOR
import com.securityc4po.api.configuration.RCN_REDUNDANT_NULLCHECK_OF_NONNULL_VALUE
import com.securityc4po.api.configuration.SIC_INNER_SHOULD_BE_STATIC
import com.securityc4po.api.finding.*
import com.securityc4po.api.project.Project
import com.securityc4po.api.project.ProjectEntity
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings
import org.junit.jupiter.api.AfterEach
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.data.mongodb.core.MongoTemplate
import org.springframework.data.mongodb.core.query.Query
import org.springframework.restdocs.operation.preprocess.Preprocessors
import org.springframework.restdocs.payload.JsonFieldType
import org.springframework.restdocs.payload.PayloadDocumentation
import org.springframework.restdocs.request.RequestDocumentation
import org.springframework.restdocs.webtestclient.WebTestClientRestDocumentation
import reactor.core.publisher.Mono

@SuppressFBWarnings(
    SIC_INNER_SHOULD_BE_STATIC,
    NP_NONNULL_FIELD_NOT_INITIALIZED_IN_CONSTRUCTOR,
    RCN_REDUNDANT_NULLCHECK_OF_NONNULL_VALUE
)
class PentestControllerDocumentationTest : BaseDocumentationIntTest() {

    @Autowired
    lateinit var mongoTemplate: MongoTemplate
    var mapper = ObjectMapper()

    @BeforeEach
    fun init() {
        configureAdminToken()
        persistBasicTestScenario()
    }

    @AfterEach
    fun destroy() {
        cleanUp()
    }

    @Nested
    inner class GetPentests {
        @Test
        fun getPentestsByProjectIdAndCategory() {
            val projectId = "d2e126ba-f608-11ec-b939-0242ac120025"
            val category = "INFORMATION_GATHERING"
            webTestClient.get()
                .uri("/pentests?projectId={projectId}&category={category}", projectId, category)
                .header("Authorization", "Bearer $tokenAdmin")
                .exchange()
                .expectStatus().isOk
                .expectHeader().doesNotExist("")
                .expectBody().json(Json.write(getProjectsResponse()))
                .consumeWith(
                    WebTestClientRestDocumentation.document(
                        "{methodName}",
                        Preprocessors.preprocessRequest(
                            Preprocessors.prettyPrint(),
                            Preprocessors.modifyUris().removePort(),
                            Preprocessors.removeHeaders("Host", "Content-Length")
                        ),
                        Preprocessors.preprocessResponse(
                            Preprocessors.prettyPrint()
                        ),
                        RequestDocumentation.relaxedRequestParameters(
                            RequestDocumentation.parameterWithName("projectId").description("The id of the project you want to get the pentests for"),
                            RequestDocumentation.parameterWithName("category").description("The category you want to get the pentests for")
                        ),
                        PayloadDocumentation.relaxedResponseFields(
                            PayloadDocumentation.fieldWithPath("[].id").type(JsonFieldType.STRING)
                                .description("The id of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("[].projectId").type(JsonFieldType.STRING)
                                .description("The id of the project of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("[].category").type(JsonFieldType.STRING)
                                .description("The category of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("[].refNumber").type(JsonFieldType.STRING)
                                .description("The reference number of the requested pentest according to the current OWASP Testing Guide"),
                            PayloadDocumentation.fieldWithPath("[].status").type(JsonFieldType.STRING)
                                .description("The status of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("[].findingIds").type(JsonFieldType.ARRAY)
                                .description("List of ids of the findings in the requested pentest"),
                            PayloadDocumentation.fieldWithPath("[].commentIds").type(JsonFieldType.ARRAY)
                                .description("List of ids of the comments of the requested pentest")
                        )
                    )
                )
        }

        private val pentestOne = Pentest(
            id = "9c8af320-f608-11ec-b939-0242ac120002",
            projectId = "d2e126ba-f608-11ec-b939-0242ac120025",
            category = PentestCategory.INFORMATION_GATHERING,
            refNumber = "OTG-INFO-001",
            status = PentestStatus.NOT_STARTED,
            findingIds = emptyList(),
            commentIds = emptyList()
        )
        private val pentestTwo = Pentest(
            id = "43fbc63c-f624-11ec-b939-0242ac120002",
            projectId = "d2e126ba-f608-11ec-b939-0242ac120025",
            category = PentestCategory.INFORMATION_GATHERING,
            refNumber = "OTG-INFO-002",
            status = PentestStatus.IN_PROGRESS,
            findingIds = listOf("ab62d365-1b1d-4da1-89bc-5496616e220f"),
            commentIds = emptyList()
        )

        private fun getProjectsResponse() = listOf(
            pentestOne.toPentestResponseBody(),
            pentestTwo.toPentestResponseBody()
        )
    }

    @Nested
    inner class SavePentest {
        @Test
        fun savePentestByProjectId() {
            val projectId = "d2e126ba-f608-11ec-b939-0242ac120025"
            webTestClient.post()
                .uri("/pentests/{projectId}", projectId)
                .header("Authorization", "Bearer $tokenAdmin")
                .body(Mono.just(newPentestBody), PentestRequestBody::class.java)
                .exchange()
                .expectStatus().isAccepted
                .expectHeader().doesNotExist("")
                .expectBody().json(Json.write(newPentestBody))
                .consumeWith(
                    WebTestClientRestDocumentation.document(
                        "{methodName}",
                        Preprocessors.preprocessRequest(
                            Preprocessors.prettyPrint(),
                            Preprocessors.modifyUris().removePort(),
                            Preprocessors.removeHeaders("Host", "Content-Length")
                        ),
                        Preprocessors.preprocessResponse(
                            Preprocessors.prettyPrint()
                        ),
                        RequestDocumentation.relaxedPathParameters(
                            RequestDocumentation.parameterWithName("projectId").description("The id of the project you want to save the pentest for")
                        ),
                        PayloadDocumentation.relaxedResponseFields(
                            PayloadDocumentation.fieldWithPath("id").type(JsonFieldType.STRING)
                                .description("The id of the created pentest"),
                            PayloadDocumentation.fieldWithPath("projectId").type(JsonFieldType.STRING)
                                .description("The id of the project of the created pentest"),
                            PayloadDocumentation.fieldWithPath("category").type(JsonFieldType.STRING)
                                .description("The category of the created pentest"),
                            PayloadDocumentation.fieldWithPath("refNumber").type(JsonFieldType.STRING)
                                .description("The reference number of the created pentest according to the current OWASP Testing Guide"),
                            PayloadDocumentation.fieldWithPath("status").type(JsonFieldType.STRING)
                                .description("The status of the created pentest"),
                            PayloadDocumentation.fieldWithPath("findingIds").type(JsonFieldType.ARRAY)
                                .description("List of ids of the findings in the created pentest"),
                            PayloadDocumentation.fieldWithPath("commentIds").type(JsonFieldType.ARRAY)
                                .description("List of ids of the comments of the created pentest")
                        )
                    )
                )
        }

        val newPentestBody = PentestRequestBody(
            projectId = "d2e126ba-f608-11ec-b939-0242ac120025",
            category = "CLIENT_SIDE_TESTING",
            refNumber = "OTG-CLIENT-001",
            status = "IN_PROGRESS",
            findingIds = emptyList<String>(),
            commentIds = emptyList<String>()
        )
    }

    @Nested
    inner class UpdatePentest {
        @Test
        fun updatePentestByProjectId() {
            val pentestOneId = "9c8af320-f608-11ec-b939-0242ac120002"
            webTestClient.patch()
                .uri("/pentests/{pentestId}", pentestOneId)
                .header("Authorization", "Bearer $tokenAdmin")
                .body(Mono.just(pentestOneBody), PentestRequestBody::class.java)
                .exchange()
                .expectStatus().isAccepted
                .expectHeader().doesNotExist("")
                .expectBody().json(Json.write(pentestOneBody))
                .consumeWith(
                    WebTestClientRestDocumentation.document(
                        "{methodName}",
                        Preprocessors.preprocessRequest(
                            Preprocessors.prettyPrint(),
                            Preprocessors.modifyUris().removePort(),
                            Preprocessors.removeHeaders("Host", "Content-Length")
                        ),
                        Preprocessors.preprocessResponse(
                            Preprocessors.prettyPrint()
                        ),
                        RequestDocumentation.relaxedPathParameters(
                            RequestDocumentation.parameterWithName("pentestId").description("The id of the pentest you want to update")
                        ),
                        PayloadDocumentation.relaxedResponseFields(
                            PayloadDocumentation.fieldWithPath("id").type(JsonFieldType.STRING)
                                .description("The id of the updated pentest"),
                            PayloadDocumentation.fieldWithPath("projectId").type(JsonFieldType.STRING)
                                .description("The id of the project of the updated pentest"),
                            PayloadDocumentation.fieldWithPath("category").type(JsonFieldType.STRING)
                                .description("The category of the updated pentest"),
                            PayloadDocumentation.fieldWithPath("refNumber").type(JsonFieldType.STRING)
                                .description("The reference number of the updated pentest according to the current OWASP Testing Guide"),
                            PayloadDocumentation.fieldWithPath("status").type(JsonFieldType.STRING)
                                .description("The status of the updated pentest"),
                            PayloadDocumentation.fieldWithPath("findingIds").type(JsonFieldType.ARRAY)
                                .description("List of ids of the findings in the updated pentest"),
                            PayloadDocumentation.fieldWithPath("commentIds").type(JsonFieldType.ARRAY)
                                .description("List of ids of the comments of the updated pentest")
                        )
                    )
                )
        }

        val pentestOneBody = PentestRequestBody(
            projectId = "d2e126ba-f608-11ec-b939-0242ac120025",
            category = "INFORMATION_GATHERING",
            refNumber = "OTG-INFO-001",
            status = "OPEN",
            findingIds = emptyList<String>(),
            commentIds = emptyList<String>()
        )
    }

    @Nested
    inner class GetFindings {
        @Test
        fun getFindingsByPentestId() {
            val pentestTwoId = "43fbc63c-f624-11ec-b939-0242ac120002"
            webTestClient.get()
                .uri("/pentests/{pentestId}/findings", pentestTwoId)
                .header("Authorization", "Bearer $tokenAdmin")
                .exchange()
                .expectStatus().isOk
                .expectHeader().doesNotExist("")
                .expectBody().json(Json.write(getFindingsResponse()))
                .consumeWith(
                    WebTestClientRestDocumentation.document(
                        "{methodName}",
                        Preprocessors.preprocessRequest(
                            Preprocessors.prettyPrint(),
                            Preprocessors.modifyUris().removePort(),
                            Preprocessors.removeHeaders("Host", "Content-Length")
                        ),
                        Preprocessors.preprocessResponse(
                            Preprocessors.prettyPrint()
                        ),
                        RequestDocumentation.relaxedPathParameters(
                            RequestDocumentation.parameterWithName("pentestId").description("The id of the pentest you want to get the findings for")
                        ),
                        PayloadDocumentation.relaxedResponseFields(
                            PayloadDocumentation.fieldWithPath("[].id").type(JsonFieldType.STRING)
                                .description("The id of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("[].severity").type(JsonFieldType.STRING)
                                .description("The severity of the finding"),
                            PayloadDocumentation.fieldWithPath("[].title").type(JsonFieldType.STRING)
                                .description("The title of the requested finding"),
                            PayloadDocumentation.fieldWithPath("[].description").type(JsonFieldType.STRING)
                                .description("The description number of the finding"),
                            PayloadDocumentation.fieldWithPath("[].impact").type(JsonFieldType.STRING)
                                .description("The impact of the finding"),
                            PayloadDocumentation.fieldWithPath("[].affectedUrls").type(JsonFieldType.ARRAY)
                                .description("List of affected Urls of the finding"),
                            PayloadDocumentation.fieldWithPath("[].reproduction").type(JsonFieldType.STRING)
                                .description("The reproduction steps of the finding"),
                            PayloadDocumentation.fieldWithPath("[].mitigation").type(JsonFieldType.STRING)
                                .description("The example mitigation for the finding")
                        )
                    )
                )
        }

        private val findingOne = Finding(
            id = "ab62d365-1b1d-4da1-89bc-5496616e220f",
            severity = Severity.LOW,
            title = "Found Bug",
            description = "OTG-INFO-002 Bug",
            impact = "Service",
            affectedUrls = emptyList(),
            reproduction = "Step 1: Hack",
            mitigation = "None"
        )

        private fun getFindingsResponse() = listOf(
            findingOne.toFindingResponseBody()
        )
    }

    @Nested
    inner class GetFinding {
        @Test
        fun getFindingById() {
            val findingId = "ab62d365-1b1d-4da1-89bc-5496616e220f"
            webTestClient.get()
                .uri("/pentests/{findingId}/finding", findingId)
                .header("Authorization", "Bearer $tokenAdmin")
                .exchange()
                .expectStatus().isOk
                .expectHeader().doesNotExist("")
                .expectBody().json(Json.write(findingOne.toFindingResponseBody()))
                .consumeWith(
                    WebTestClientRestDocumentation.document(
                        "{methodName}",
                        Preprocessors.preprocessRequest(
                            Preprocessors.prettyPrint(),
                            Preprocessors.modifyUris().removePort(),
                            Preprocessors.removeHeaders("Host", "Content-Length")
                        ),
                        Preprocessors.preprocessResponse(
                            Preprocessors.prettyPrint()
                        ),
                        RequestDocumentation.relaxedPathParameters(
                            RequestDocumentation.parameterWithName("findingId").description("The id of the feinidng you want to get")
                        ),
                        PayloadDocumentation.relaxedResponseFields(
                            PayloadDocumentation.fieldWithPath("id").type(JsonFieldType.STRING)
                                .description("The id of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("severity").type(JsonFieldType.STRING)
                                .description("The severity of the finding"),
                            PayloadDocumentation.fieldWithPath("title").type(JsonFieldType.STRING)
                                .description("The title of the requested finding"),
                            PayloadDocumentation.fieldWithPath("description").type(JsonFieldType.STRING)
                                .description("The description number of the finding"),
                            PayloadDocumentation.fieldWithPath("impact").type(JsonFieldType.STRING)
                                .description("The impact of the finding"),
                            PayloadDocumentation.fieldWithPath("affectedUrls").type(JsonFieldType.ARRAY)
                                .description("List of affected Urls of the finding"),
                            PayloadDocumentation.fieldWithPath("reproduction").type(JsonFieldType.STRING)
                                .description("The reproduction steps of the finding"),
                            PayloadDocumentation.fieldWithPath("mitigation").type(JsonFieldType.STRING)
                                .description("The example mitigation for the finding")
                        )
                    )
                )
        }

        private val findingOne = Finding(
            id = "ab62d365-1b1d-4da1-89bc-5496616e220f",
            severity = Severity.LOW,
            title = "Found Bug",
            description = "OTG-INFO-002 Bug",
            impact = "Service",
            affectedUrls = emptyList(),
            reproduction = "Step 1: Hack",
            mitigation = "None"
        )
    }

    @Nested
    inner class SaveFinding {
        @Test
        fun saveFindingByPentestId() {
            val pentestTwoId = "43fbc63c-f624-11ec-b939-0242ac120002"
            webTestClient.post()
                .uri("/pentests/{pentestId}/finding", pentestTwoId)
                .header("Authorization", "Bearer $tokenAdmin")
                .body(Mono.just(findingBody), FindingRequestBody::class.java)
                .exchange()
                .expectStatus().isAccepted
                .expectHeader().doesNotExist("")
                .expectBody().json(Json.write(findingBody))
                .consumeWith(
                    WebTestClientRestDocumentation.document(
                        "{methodName}",
                        Preprocessors.preprocessRequest(
                            Preprocessors.prettyPrint(),
                            Preprocessors.modifyUris().removePort(),
                            Preprocessors.removeHeaders("Host", "Content-Length")
                        ),
                        Preprocessors.preprocessResponse(
                            Preprocessors.prettyPrint()
                        ),
                        RequestDocumentation.relaxedPathParameters(
                            RequestDocumentation.parameterWithName("pentestId").description("The id of the pentest you want to save the finding for")
                        ),
                        PayloadDocumentation.relaxedResponseFields(
                            PayloadDocumentation.fieldWithPath("id").type(JsonFieldType.STRING)
                                .description("The id of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("severity").type(JsonFieldType.STRING)
                                .description("The severity of the finding"),
                            PayloadDocumentation.fieldWithPath("title").type(JsonFieldType.STRING)
                                .description("The title of the requested finding"),
                            PayloadDocumentation.fieldWithPath("description").type(JsonFieldType.STRING)
                                .description("The description number of the finding"),
                            PayloadDocumentation.fieldWithPath("impact").type(JsonFieldType.STRING)
                                .description("The impact of the finding"),
                            PayloadDocumentation.fieldWithPath("affectedUrls").type(JsonFieldType.ARRAY)
                                .description("List of affected Urls of the finding"),
                            PayloadDocumentation.fieldWithPath("reproduction").type(JsonFieldType.STRING)
                                .description("The reproduction steps of the finding"),
                            PayloadDocumentation.fieldWithPath("mitigation").type(JsonFieldType.STRING)
                                .description("The example mitigation for the finding")
                        )
                    )
                )
        }

        private val findingBody = FindingRequestBody(
            severity = "MEDIUM",
            title = "Found another Bug",
            description = "Another OTG-INFO-002 Bug",
            impact = "Service",
            affectedUrls = emptyList(),
            reproduction = "Step 1: Hack more",
            mitigation = "Another None"
        )
    }

    @Nested
    inner class UpdateFinding {
        @Test
        fun updateFindingById() {
            val findingId = "ab62d365-1b1d-4da1-89bc-5496616e220f"
            webTestClient.patch()
                .uri("/pentests/{findingId}/finding", findingId)
                .header("Authorization", "Bearer $tokenAdmin")
                .body(Mono.just(findingBody), FindingRequestBody::class.java)
                .exchange()
                .expectStatus().isAccepted
                .expectHeader().doesNotExist("")
                .expectBody().json(Json.write(findingBody))
                .consumeWith(
                    WebTestClientRestDocumentation.document(
                        "{methodName}",
                        Preprocessors.preprocessRequest(
                            Preprocessors.prettyPrint(),
                            Preprocessors.modifyUris().removePort(),
                            Preprocessors.removeHeaders("Host", "Content-Length")
                        ),
                        Preprocessors.preprocessResponse(
                            Preprocessors.prettyPrint()
                        ),
                        RequestDocumentation.relaxedPathParameters(
                            RequestDocumentation.parameterWithName("findingId").description("The id of the finding you want to update")
                        ),
                        PayloadDocumentation.relaxedResponseFields(
                            PayloadDocumentation.fieldWithPath("id").type(JsonFieldType.STRING)
                                .description("The id of the requested pentest"),
                            PayloadDocumentation.fieldWithPath("severity").type(JsonFieldType.STRING)
                                .description("The severity of the finding"),
                            PayloadDocumentation.fieldWithPath("title").type(JsonFieldType.STRING)
                                .description("The title of the requested finding"),
                            PayloadDocumentation.fieldWithPath("description").type(JsonFieldType.STRING)
                                .description("The description number of the finding"),
                            PayloadDocumentation.fieldWithPath("impact").type(JsonFieldType.STRING)
                                .description("The impact of the finding"),
                            PayloadDocumentation.fieldWithPath("affectedUrls").type(JsonFieldType.ARRAY)
                                .description("List of affected Urls of the finding"),
                            PayloadDocumentation.fieldWithPath("reproduction").type(JsonFieldType.STRING)
                                .description("The reproduction steps of the finding"),
                            PayloadDocumentation.fieldWithPath("mitigation").type(JsonFieldType.STRING)
                                .description("The example mitigation for the finding")
                        )
                    )
                )
        }

        private val findingBody = FindingRequestBody(
            severity = "HIGH",
            title = "Updated Bug",
            description = "Updated OTG-INFO-002 Bug",
            impact = "Service",
            affectedUrls = emptyList(),
            reproduction = "Step 1: Hack",
            mitigation = "Still None"
        )
    }

    private fun persistBasicTestScenario() {
        // setup test data
        // Project
        val projectOne = Project(
            id = "d2e126ba-f608-11ec-b939-0242ac120025",
            client = "E Corp",
            title = "Some Mock API (v1.0) Scanning",
            createdAt = "2021-01-10T18:05:00Z",
            tester = "Novatester",
            projectPentests = emptyList(),
            createdBy = "f8aab31f-4925-4242-a6fa-f98135b4b032"
        )
        // Pentests
        val pentestOne = Pentest(
            id = "9c8af320-f608-11ec-b939-0242ac120002",
            projectId = "d2e126ba-f608-11ec-b939-0242ac120025",
            category = PentestCategory.INFORMATION_GATHERING,
            refNumber = "OTG-INFO-001",
            status = PentestStatus.NOT_STARTED,
            findingIds = emptyList(),
            commentIds = emptyList()
        )
        val pentestTwo = Pentest(
            id = "43fbc63c-f624-11ec-b939-0242ac120002",
            projectId = "d2e126ba-f608-11ec-b939-0242ac120025",
            category = PentestCategory.INFORMATION_GATHERING,
            refNumber = "OTG-INFO-002",
            status = PentestStatus.IN_PROGRESS,
            findingIds = listOf("ab62d365-1b1d-4da1-89bc-5496616e220f"),
            commentIds = emptyList()
        )
        val pentestThree = Pentest(
            id = "74eae112-f62c-11ec-b939-0242ac120002",
            projectId = "d2e126ba-f608-11ec-b939-0242ac120025",
            category = PentestCategory.AUTHENTICATION_TESTING,
            refNumber = "OTG-AUTHN-001",
            status = PentestStatus.COMPLETED,
            findingIds = emptyList(),
            commentIds = emptyList()
        )
        // Findings
        val findingOne = Finding(
            id = "ab62d365-1b1d-4da1-89bc-5496616e220f",
            severity = Severity.LOW,
            title = "Found Bug",
            description = "OTG-INFO-002 Bug",
            impact = "Service",
            affectedUrls = emptyList(),
            reproduction = "Step 1: Hack",
            mitigation = "None"
        )
        // persist test data in database
        mongoTemplate.save(ProjectEntity(projectOne))
        mongoTemplate.save(PentestEntity(pentestOne))
        mongoTemplate.save(PentestEntity(pentestTwo))
        mongoTemplate.save(PentestEntity(pentestThree))
        mongoTemplate.save(FindingEntity(findingOne))
    }

    private fun configureAdminToken() {
        tokenAdmin = getAccessToken("test_admin", "test", "c4po_local", "c4po_realm_local")
    }

    private fun cleanUp() {
        mongoTemplate.findAllAndRemove(Query(), ProjectEntity::class.java)
        mongoTemplate.findAllAndRemove(Query(), PentestEntity::class.java)
        mongoTemplate.findAllAndRemove(Query(), FindingEntity::class.java)

        tokenAdmin = "n/a"
    }
}